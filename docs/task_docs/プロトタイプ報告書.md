# プロトタイプ報告書（競艇データ収集基盤）

## 1. はじめに

本報告書は、競艇データ収集基盤のプロトタイプ実装の現状、および現時点での仕様と課題をまとめたものです。当初の設計に基づき、指定された日付の主要なレース場データの一部（1レース目）を取得する機能を実装し、その動作確認を行いました。

## 2. 現在の仕様

本プロトタイプは Python スクリプト (`src/scrape_prototype.py`) として実装されており、以下の主要ライブラリを使用しています。

- **requests:** WebページへのHTTPリクエスト送信
- **BeautifulSoup4:** HTMLコンテンツの解析とデータ抽出
- **SQLAlchemy:** SQLiteデータベースへの接続とデータ操作 (ORM)

具体的な処理フローは以下の通りです。

1.  **設定値の定義:**
    - 取得対象日 (`TARGET_DATE`)
    - 取得対象レース番号 (`RACE_NO`)
    - 処理対象とする会場IDの上限 (`MAX_VENUE_ID`)
    - リクエスト間隔 (`REQUEST_INTERVAL`)
    - データベースファイルパス (`DB_FILE`)
2.  **データベース初期化 (`init_database`):**
    - 実行時に既存のデータベースファイル (`data/boat_data.db`) が存在する場合は削除し、テーブルスキーマ（`Venue`, `Race`, `RaceEntry`）を再作成します。
    - `Venue` テーブルに全24会場の基本情報（会場コード、名称）を登録します。
3.  **開催中レース場の特定 (`get_active_venues`):**
    - `TARGET_DATE` のレース一覧ページ (`/owpc/pc/race/index`) にアクセスします。
    - ページ内の出走表リンク (`/owpc/pc/race/racelist`) を解析し、開催中のレース場コード (`jcd`) のセットを取得します。
4.  **対象レース場の選定:**
    - 取得した開催中レース場の中から、`jcd` が `MAX_VENUE_ID` 以下のものだけを処理対象として絞り込みます。
5.  **データ取得ループ:**
    - 処理対象となった各レース場コード (`jcd`) について、以下の処理を繰り返します。
        a.  **URL生成 (`generate_urls`):** 出走表、直前情報のURLを生成します。
        b.  **HTML取得 (`fetch_html`):** `requests` ライブラリを使用して、各URLからHTMLコンテンツを取得します。取得失敗時はログに記録し、次の処理に進みます。
        c.  **データ抽出:**
            - 出走表HTMLからレース基本情報 (`extract_race_info`) と選手基本情報 (`extract_entry_info`) を抽出します。
            - 直前情報HTMLから気象情報と選手の直前情報 (`extract_live_info`) を抽出します。
            - 抽出した情報は辞書形式で保持されます。
        d.  **データ統合:** 出走表から抽出した情報と直前情報から抽出した情報を結合します。
        e.  **データベース保存:**
            - SQLAlchemy を使用してデータベースセッションを開始します。
            - `Race` オブジェクトを作成し、レース情報（気象情報含む）を格納します。
            - `RaceEntry` オブジェクトを各選手分作成し、選手情報（基本情報、直前情報）を格納します。`Race` オブジェクトとリレーションを設定します。
            - データをコミットし、セッションを閉じます。
        f.  **待機:** `REQUEST_INTERVAL` で指定された秒数だけ待機し、次の会場の処理に移ります。
6.  **ロギング:** 処理の主要なステップやエラーは、コンソールとログファイル (`logs/scrape.log`) に出力されます。

## 3. データ取得状況の確認結果

直近のテスト実行（対象会場: 01 桐生, 04 平和島, 05 多摩川）により、以下のデータがデータベースに格納されていることを確認しました。

- **レース情報:** 会場コード、会場名、指定日のレース番号、レース名、距離、安定板使用フラグが正しく取得できています。
- **気象情報:** 天候、風速、水温、波高は取得できるようになりました。
- **選手基本情報（出走表より）:** 枠番、登録番号、級別、F/L数、平均ST、各種勝率・連率、モーター/ボート番号・連率が正しく取得できています。
- **選手直前情報（直前情報より）:** 調整体重、展示タイム、チルトが正しく取得できています。

いくつかの項目でデータが取得できていないことが判明しました。

## 4. 判明した課題

現在の実装において、以下の課題が見つかっています。

- **風向き情報の未取得:** 直前情報ページからの風向き情報が取得できていません。HTML構造を確認し、適切なセレクタを再調査・修正する必要があります。画像のクラス名から方角を判断するロジックが必要になる可能性があります。
- **部品交換情報の未取得:** 直前情報ページからの部品交換情報が取得できていません。HTML構造を確認し、適切なセレクタを再調査・修正する必要があります。

## 5. 今後の課題（積み残しタスク）

今回のプロトタイプ実装では対応せず、今後のタスクとして積み残す項目は以下の通りです。

- Player（選手）テーブルの実装と選手基本情報の格納（現在はレースごとのエントリーとして保存）
- 安定板使用レースの検出と特別な処理の要否判断
- 複数日程・複数レースのデータをバッチ処理する機能の実装
- レース結果情報の取得・保存
- その他、舟券購入に関する情報やオッズ情報の取得

これらの課題については、今後のフェーズで対応を検討します。

以上。 